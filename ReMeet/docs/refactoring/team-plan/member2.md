# メンバー2: データ層・リポジトリパターン担当

## 担当概要
データ層の抽象化とリポジトリパターンの導入を担当。既存の `sqlite-services` を新しいリポジトリ実装に安全に移行し、外部APIを変更せずに内部実装のみを変更する。

## 全体タスク期間: 5日間

---

## タスク1: 既存データ層の調査とリポジトリ設計（1日目）

### 1.1 既存サービス層の詳細調査
**所要時間**: 2時間
**重要度**: 高

- [ ] `database/sqlite-services/` 内の全ファイルを調査
- [ ] `PersonService`, `EventService`, `TagService` の全メソッドを記録
- [ ] 特に `PersonService.findOrCreateByNames()` などの重要APIを特定
- [ ] 既存のビジネスロジック（フィルタリング、検索）を詳細に分析

### 1.2 現在のデータフローの把握
**所要時間**: 2時間
**重要度**: 高

- [ ] サービス層とUI層の連携方法を調査
- [ ] TanStack Query との連携パターンを分析
- [ ] Jotai Atoms との連携パターンを分析
- [ ] 既存のエラーハンドリング方法を調査

### 1.3 リポジトリインターフェースの設計
**所要時間**: 2時間
**重要度**: 高

- [ ] `IPersonRepository`, `IEventRepository`, `ITagRepository` インターフェースを設計
- [ ] 各インターフェースのメソッドシグネチャを定義
- [ ] 既存サービスの全機能をカバーすることを確認
- [ ] 型定義を `PersonWithRelations`, `Event`, `Tag` と完全に互換にする

### 1.4 依存性注入（DI）パターンの設計
**所要時間**: 1時間
**重要度**: 中

- [ ] サービス層がリポジトリ層に依存する構造を設計
- [ ] DIコンテナの必要性を検討
- [ ] 既存コードへの影響を最小化する方法を検討
- [ ] テスト容易性を考慮した設計を作成

### 1.5 移行計画の作成
**所要時間**: 1時間
**重要度**: 高

- [ ] 段階的な移行手順を詳細に記載
- [ ] 各段階での破壊的変更がないことを確認
- [ ] ロールバック手順を作成
- [ ] 他メンバーとの連携ポイントを明確化

---

## タスク2: リポジトリインターフェースの実装（2日目）

### 2.1 repositories ディレクトリの作成
**所要時間**: 1時間
**重要度**: 高

- [ ] `repositories/interfaces/` ディレクトリを作成
- [ ] `repositories/implementations/` ディレクトリを作成
- [ ] 各ディレクトリのindex.tsファイルのテンプレートを準備
- [ ] TypeScript設定を確認

### 2.2 IPersonRepository の実装
**所要時間**: 1.5時間
**重要度**: 高

- [ ] `repositories/interfaces/IPersonRepository.ts` を作成
- [ ] 全CRUD操作のメソッドを定義
- [ ] 検索・フィルタリング機能のメソッドを定義
- [ ] `PersonWithRelations` 型との完全な互換性を確保
- [ ] 既存のPersonServiceの全機能をカバー

### 2.3 IEventRepository の実装
**所要時間**: 1時間
**重要度**: 高

- [ ] `repositories/interfaces/IEventRepository.ts` を作成
- [ ] 全CRUD操作のメソッドを定義
- [ ] 人物-イベント関連付け機能のメソッドを定義
- [ ] `Event` 型との完全な互換性を確保
- [ ] 既存のEventServiceの全機能をカバー

### 2.4 ITagRepository の実装
**所要時間**: 1時間
**重要度**: 高

- [ ] `repositories/interfaces/ITagRepository.ts` を作成
- [ ] 全CRUD操作のメソッドを定義
- [ ] `findOrCreateByNames` 機能のメソッドを定義
- [ ] `Tag` 型との完全な互換性を確保
- [ ] 既存のTagServiceの全機能をカバー

### 2.5 インターフェースの統合とテスト
**所要時間**: 3.5時間
**重要度**: 高

- [ ] 各インターフェースの型定義を確認
- [ ] TypeScriptコンパイルエラーがないことを確認
- [ ] 既存サービスとの互換性を確認
- [ ] インターフェースドキュメントを作成

---

## タスク3: モックリポジトリの実装（3日目）

### 3.1 MockPersonRepository の実装
**所要時間**: 2時間
**重要度**: 高

- [ ] `repositories/implementations/MockPersonRepository.ts` を作成
- [ ] `IPersonRepository` インターフェースを実装
- [ ] 既存の `sqlite-services` のPersonService機能を完全に移植
- [ ] 全てのCRUD操作、検索機能を実装
- [ ] 既存のビジネスロジックを維持

### 3.2 MockEventRepository の実装
**所要時間**: 1.5時間
**重要度**: 高

- [ ] `repositories/implementations/MockEventRepository.ts` を作成
- [ ] `IEventRepository` インターフェースを実装
- [ ] 既存の `sqlite-services` のEventService機能を完全に移植
- [ ] 人物-イベント関連付け機能を実装
- [ ] 既存のビジネスロジックを維持

### 3.3 MockTagRepository の実装
**所要時間**: 1.5時間
**重要度**: 高

- [ ] `repositories/implementations/MockTagRepository.ts` を作成
- [ ] `ITagRepository` インターフェースを実装
- [ ] 既存の `sqlite-services` のTagService機能を完全に移植
- [ ] **重要**: `findOrCreateByNames` 機能を完全に実装
- [ ] 既存のビジネスロジックを維持

### 3.4 モックリポジトリの統合
**所要時間**: 1時間
**重要度**: 中

- [ ] 各モックリポジトリの統合テスト
- [ ] リポジトリ間の連携機能を確認
- [ ] データの整合性を確認
- [ ] パフォーマンステストを実施

### 3.5 リポジトリの動作確認
**所要時間**: 2時間
**重要度**: 高

- [ ] 各リポジトリの全機能を個別テスト
- [ ] 既存サービスとの動作比較
- [ ] データの正確性を確認
- [ ] 問題があれば修正

---

## タスク4: サービス層の内部実装変更（4日目）

### 4.1 PersonService の内部実装変更
**所要時間**: 2時間
**重要度**: 高

- [ ] `PersonService` を新しいリポジトリを使用するように変更
- [ ] **重要**: 外部APIは一切変更しない
- [ ] 依存性注入パターンを導入
- [ ] 既存のビジネスロジックを完全に維持
- [ ] 変更前後で動作が同じことを確認

### 4.2 EventService の内部実装変更
**所要時間**: 1.5時間
**重要度**: 高

- [ ] `EventService` を新しいリポジトリを使用するように変更
- [ ] **重要**: 外部APIは一切変更しない
- [ ] 依存性注入パターンを導入
- [ ] 既存のビジネスロジックを完全に維持
- [ ] 変更前後で動作が同じことを確認

### 4.3 TagService の内部実装変更
**所要時間**: 1.5時間
**重要度**: 高

- [ ] `TagService` を新しいリポジトリを使用するように変更
- [ ] **重要**: 外部APIは一切変更しない
- [ ] **重要**: `findOrCreateByNames` 機能を完全に維持
- [ ] 依存性注入パターンを導入
- [ ] 既存のビジネスロジックを完全に維持

### 4.4 サービス層の統合テスト
**所要時間**: 1時間
**重要度**: 高

- [ ] 全サービスの統合テスト
- [ ] 既存のUI層との連携確認
- [ ] TanStack Query との連携確認
- [ ] エラーハンドリングの確認

### 4.5 旧コードとの互換性確認
**所要時間**: 2時間
**重要度**: 高

- [ ] 既存のUI層から見た動作に変更がないことを確認
- [ ] 全ての外部APIが正常に動作することを確認
- [ ] パフォーマンスが劣化していないことを確認
- [ ] 問題があれば即座に修正

---

## タスク5: 最終統合とドキュメント作成（5日目）

### 5.1 database/sqlite-services/index.ts の更新
**所要時間**: 1時間
**重要度**: 中

- [ ] エクスポートエイリアスをレビュー
- [ ] よりシンプルで分かりやすい命名規則を検討
- [ ] 既存のimportに影響がないことを確認
- [ ] 必要に応じて改善を実施

### 5.2 依存関係の最適化
**所要時間**: 1時間
**重要度**: 中

- [ ] 新しいリポジトリ層の依存関係を最適化
- [ ] 不要な依存関係を削除
- [ ] 循環参照がないことを確認
- [ ] パフォーマンスの最適化

### 5.3 全体統合テスト
**所要時間**: 2時間
**重要度**: 高

- [ ] 全データ層の統合テスト
- [ ] 既存UI層との完全な互換性確認
- [ ] 全ての既存機能が正常に動作することを確認
- [ ] エラーケースの動作確認

### 5.4 ドキュメント作成
**所要時間**: 2時間
**重要度**: 中

- [ ] リポジトリパターンの実装ドキュメント
- [ ] 新しいアーキテクチャの解説
- [ ] 使用方法とベストプラクティス
- [ ] 移行手順書の作成

### 5.5 完了報告と引き継ぎ
**所要時間**: 2時間
**重要度**: 高

- [ ] 作業完了報告書を作成
- [ ] 変更内容の詳細を記録
- [ ] 他メンバーへの引き継ぎ資料を作成
- [ ] 注意事項と制限事項を整理
- [ ] 次フェーズの準備を完了

---

## 成果物

1. **リポジトリインターフェース**
   - `IPersonRepository.ts`, `IEventRepository.ts`, `ITagRepository.ts`

2. **モックリポジトリ実装**
   - `MockPersonRepository.ts`, `MockEventRepository.ts`, `MockTagRepository.ts`

3. **更新されたサービス層**
   - 内部実装のみ変更、外部APIは完全に維持

4. **ドキュメント**
   - リポジトリパターン実装ドキュメント
   - アーキテクチャ解説
   - 引き継ぎ資料

## 重要な注意事項

1. **既存API の完全保持**
   - 外部からのAPIは一切変更しない
   - 特に `PersonService.findOrCreateByNames()` は完全に維持
   - 既存のビジネスロジックは完全に維持

2. **段階的な移行**
   - 内部実装のみを変更
   - 外部への影響をゼロにする
   - 各段階で動作確認を実施

3. **データの整合性**
   - 既存データとの完全な互換性を保つ
   - データの損失や破損を絶対に避ける
   - 移行前後でデータが同じことを確認

4. **パフォーマンスの維持**
   - 既存のパフォーマンスを維持
   - 新しいアーキテクチャで性能劣化がないことを確認
   - 必要に応じて最適化を実施

5. **テストの徹底**
   - 各段階で必ず動作確認
   - 既存機能との完全な互換性確認
   - 問題があれば即座にロールバック